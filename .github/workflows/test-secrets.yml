name: Test Secrets

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # 9:30 AM ET (market open) = 14:30 UTC during winter, 13:30 UTC during summer
    # Using 14:30 UTC to catch market open in winter, first hour in summer
    - cron: '30 14 * * 1-5'  # Weekdays only (Mon-Fri)
  push:
    branches:
      - 'claude/**'

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Verify secrets are set
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Checking if secrets are configured..."

          if [ -z "$ALPACA_API_KEY" ]; then
            echo "‚ùå ALPACA_API_KEY is NOT set"
            exit 1
          else
            echo "‚úÖ ALPACA_API_KEY is set (length: ${#ALPACA_API_KEY})"
          fi

          if [ -z "$ALPACA_SECRET_KEY" ]; then
            echo "‚ùå ALPACA_SECRET_KEY is NOT set"
            exit 1
          else
            echo "‚úÖ ALPACA_SECRET_KEY is set (length: ${#ALPACA_SECRET_KEY})"
          fi

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ùå ANTHROPIC_API_KEY is NOT set"
            exit 1
          else
            echo "‚úÖ ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
          fi

          echo ""
          echo "üéâ All secrets are configured!"

      - name: Test Alpaca API connection
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_PAPER: "true"
        run: |
          python -c "
          from alpaca.trading.client import TradingClient
          import os

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )
          account = client.get_account()
          print(f'‚úÖ Alpaca API connected!')
          print(f'   Account status: {account.status}')
          print(f'   Buying power: \${float(account.buying_power):,.2f}')
          "

      - name: Test Anthropic API connection
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python -c "
          import anthropic
          import os

          client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          # Just verify the client initializes - don't make an actual API call to save costs
          print('‚úÖ Anthropic client initialized successfully!')
          "
