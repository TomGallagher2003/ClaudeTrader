name: Verify Credentials

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check environment variables are set
        run: |
          echo "Checking if secrets are configured..."
          echo "=========================================="

          if [ -z "${{ secrets.ALPACA_API_KEY }}" ]; then
            echo "❌ ALPACA_API_KEY is NOT set in repository secrets"
          else
            echo "✅ ALPACA_API_KEY is set (length: ${#ALPACA_API_KEY})"
          fi

          if [ -z "${{ secrets.ALPACA_SECRET_KEY }}" ]; then
            echo "❌ ALPACA_SECRET_KEY is NOT set in repository secrets"
          else
            echo "✅ ALPACA_SECRET_KEY is set (length: ${#ALPACA_SECRET_KEY})"
          fi

          if [ -z "${{ secrets.ALPACA_PAPER }}" ]; then
            echo "⚠️  ALPACA_PAPER is NOT set (will default to 'true')"
          else
            echo "✅ ALPACA_PAPER is set to: ${{ secrets.ALPACA_PAPER }}"
          fi

          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "❌ ANTHROPIC_API_KEY is NOT set in repository secrets"
          else
            echo "✅ ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
          fi

          echo "=========================================="
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Verify Alpaca API credentials
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_PAPER: ${{ secrets.ALPACA_PAPER }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python verify_credentials.py

      - name: Summary
        if: always()
        run: |
          echo "## Credential Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the step outputs above to see:" >> $GITHUB_STEP_SUMMARY
          echo "- Which secrets are configured" >> $GITHUB_STEP_SUMMARY
          echo "- Whether API credentials are valid" >> $GITHUB_STEP_SUMMARY
          echo "- Current market status" >> $GITHUB_STEP_SUMMARY
